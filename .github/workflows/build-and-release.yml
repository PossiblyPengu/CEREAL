name: Build and Release

on:
  push:
    tags: ['v*.*.*']
  workflow_dispatch: {}

jobs:
  build-and-publish:
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: List artifacts
        run: ls dist

      - name: Extract release notes from tag
        if: startsWith(github.ref, 'refs/tags/')
        id: notes
        shell: bash
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          # Get the tag annotation message (skip the first line which is "Release vX.Y.Z")
          BODY=$(git tag -l --format='%(contents:body)' "$TAG")
          if [ -z "$BODY" ]; then
            echo "has_notes=false" >> "$GITHUB_OUTPUT"
          else
            # Write to a file to avoid escaping issues
            echo "$BODY" > release-notes.txt
            echo "has_notes=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          NOTES_ARG=""
          if [ "${{ steps.notes.outputs.has_notes }}" = "true" ]; then
            NOTES_ARG="--notes-file release-notes.txt"
          else
            NOTES_ARG="--generate-notes"
          fi
          gh release create "$TAG" dist/* --repo "${{ github.repository }}" --title "$TAG" $NOTES_ARG
